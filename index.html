<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mimid | Bird Vocalization Flashcards</title>
    <link rel="stylesheet" href="index.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:ital,wght@0,700;1,700&display=swap"
        rel="stylesheet">
</head>

<body>
    <div id="loading" class="loading-overlay">
        <div class="audio-controls">
            <div class="visualizer" style="display: flex;">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
            </div>
            <p>Gathering bird songs...</p>
        </div>
    </div>

    <div id="app">
        <div id="setupView" class="setup-container">
            <header style="text-align: center; margin-bottom: 2rem;">
                <h1>mimid</h1>
                <p style="color: var(--text-muted); margin-top: 0.5rem;">Bird Vocalization Training</p>
            </header>

            <div class="settings-card">
                <h3>Configure Session</h3>

                <div class="settings-group">
                    <h4>Region (Optional)</h4>
                    <div style="position: relative;">
                        <input type="text" id="regionSearch" class="search-input"
                            placeholder="Search State, Province, or Country..." autocomplete="off">
                        <div id="regionResults" class="dropdown-results hidden"></div>
                    </div>
                </div>

                <div class="settings-group">
                    <h4>Vocalization Type</h4>
                    <select id="globalType" class="search-input" style="cursor: pointer;">
                        <option value="">Vocalization: Any</option>
                        <option value="song">Songs Only</option>
                        <option value="call">Calls Only</option>
                    </select>
                </div>

                <div class="settings-group">
                    <h4>Study Group</h4>
                    <div style="position: relative;">
                        <select id="familySelect" class="search-input" style="cursor: pointer;">
                            <option value="">Add a Family...</option>
                        </select>
                    </div>
                    <div class="filter-list" id="selectedFamiliesList"></div>

                    <div style="position: relative; margin-top: 0.5rem;">
                        <input type="text" id="speciesSearch" class="search-input" placeholder="Add specific species..."
                            autocomplete="off">
                        <div id="speciesResults" class="dropdown-results hidden"></div>
                    </div>
                    <div class="filter-list" id="selectedSpeciesList"></div>
                </div>

                <div id="speciesListSummary" class="settings-group"
                    style="display: none; border-color: var(--accent-primary);">
                    <h4 style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: var(--text-main);">Projected Species List</span>
                        <span id="speciesCountBadge" class="filter-chip" style="margin: 0;">0</span>
                    </h4>
                    <p id="speciesListPreview"></p>
                </div>

                <button class="create-session-btn" id="createSessionBtn">Start Study Session</button>

                <p id="poolStatus"
                    style="text-align: center; font-size: 0.8rem; color: var(--text-muted); margin-top: 1rem; height: 1.2em;">
                </p>

                <p class="advanced-toggle" id="toggleAdvanced" style="margin-top: 1rem;">Advanced Settings</p>
                <div id="advancedSettings" class="hidden"
                    style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--glass-border);">
                    <input type="text" id="xcApiKey" class="search-input" placeholder="XC API Key" autocomplete="on">
                    <input type="text" id="eBirdApiKey" class="search-input" placeholder="eBird API Key"
                        autocomplete="on" style="margin-top: 0.5rem;">
                    <p id="keyStatus" style="font-size: 0.65rem; color: var(--text-muted); margin-top: 0.4rem;">Status:
                        Checking...</p>
                </div>
            </div>
        </div>

        <div id="studyView" class="active-session-container hidden">
            <header class="session-header">
                <button class="secondary" id="endSessionBtn" style="padding: 0.5rem 1rem; font-size: 0.9rem;">Wait, go
                    back</button>
                <h2 style="font-size: 1.2rem; color: var(--text-muted);">Study Session</h2>
                <div style="width: 100px;"></div> <!-- Spacer -->
            </header>

            <main class="main-content">
                <div id="loadingBanner" class="progress-banner hidden">
                    <p id="loadingStatus" style="font-size: 0.9rem; font-weight: 600;">Preparing Session...</p>
                    <div class="progress-bar-bg">
                        <div id="progressBarFill" class="progress-bar-fill"></div>
                    </div>
                </div>

                <!-- Start Screen Removed - Merged into Setup View -->

                <div class="card-container hidden-card" id="cardContainer">
                    <div class="flashcard">
                        <div class="card-face front">
                            <div class="audio-controls">
                                <button class="play-button" id="playButton">
                                    <svg width="40" height="40" viewBox="0 0 24 24" fill="white">
                                        <path d="M8 5v14l11-7z" />
                                    </svg>
                                </button>
                                <button class="play-button" id="pauseButton" style="display: none;">
                                    <svg width="40" height="40" viewBox="0 0 24 24" fill="white">
                                        <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
                                    </svg>
                                </button>
                                <p id="promptText">Playing vocalization...</p>
                                <div class="visualizer" id="viz" style="display: none;">
                                    <div class="bar" style="animation-delay: 0.0s"></div>
                                    <div class="bar" style="animation-delay: 0.2s"></div>
                                    <div class="bar" style="animation-delay: 0.4s"></div>
                                    <div class="bar" style="animation-delay: 0.1s"></div>
                                    <div class="bar" style="animation-delay: 0.3s"></div>
                                </div>
                            </div>
                        </div>
                        <div class="card-face back">
                            <div class="species-image-container">
                                <img id="speciesImage" src="" alt="">
                                <p id="imageAttribution" class="attribution"></p>
                            </div>
                            <h2 class="species-name" id="speciesName">Unknown</h2>
                            <p class="species-family" id="speciesFamily"
                                style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;"></p>
                            <p class="vocalization-type" id="vocalType">Song</p>
                            <span class="location-tag" id="locationTag">Unknown</span>
                        </div>
                    </div>
                </div>

                <div class="controls hidden-card" id="sessionScreen">
                    <button class="secondary" id="revealBtn">Reveal Answer</button>
                    <div id="ratingButtons" class="rating-group hidden-card">
                        <button class="rating-btn again" data-grade="1">Incorrect</button>
                        <button class="rating-btn hard" data-grade="2">Correct (Hard)</button>
                        <button class="rating-btn easy" data-grade="4">Correct (Easy)</button>
                    </div>
                    <button class="secondary" id="resetBtn"
                        style="margin-top: 1rem; background: var(--danger); opacity: 0.8; color: #ff6b6b; border-color: #ff6b6b;">Reset
                        All Progress</button>
                </div>
                <p id="statsText" style="margin-top: 1rem; color: var(--text-muted); font-size: 0.9rem;"></p>
        </div>
    </div>

    <audio id="birdAudio"></audio>

    <script>
        let currentPool = [];
        let currentRecord = null;
        let isFlipped = false;
        let isSessionActive = false;
        let selectedSpecies = new Set();
        let selectedFamilies = new Set();

        let SPECIES_LIST = [];
        let familyToSpeciesList = new Map();
        let SCI_TO_FAMILY = {};
        let EN_TO_SCI = {};

        const speciesMetadataCache = new Map();

        const xcApiKeyInput = document.getElementById('xcApiKey');
        const globalTypeInput = document.getElementById('globalType');
        const createSessionBtn = document.getElementById('createSessionBtn');
        const loadingBanner = document.getElementById('loadingBanner');
        const loadingStatus = document.getElementById('loadingStatus');
        const progressBarFill = document.getElementById('progressBarFill');
        const startBtn = document.getElementById('startBtn');
        const toggleAdvanced = document.getElementById('toggleAdvanced');
        const advancedSettings = document.getElementById('advancedSettings');

        function getMetadata() { return JSON.parse(localStorage.getItem('mimid_metadata') || '{}'); }

        async function fetchSpeciesData(species) {
            if (speciesMetadataCache.has(species)) return speciesMetadataCache.get(species);

            const sciName = EN_TO_SCI[species] || species;
            const apiKey = xcApiKeyInput.value.trim() || 'demo';
            const maskKey = (key) => key.length > 8 ? key.substring(0, 4) + '...' + key.substring(key.length - 4) : '****';

            let q = `sp:"${sciName}" q:A len:10-60`;
            const gType = globalTypeInput.value.trim();
            if (gType) q += ` type:"${gType}"`;

            console.log(`Fetching XC data for ${species}: [${q}] (Key: ${maskKey(apiKey)})`);

            const tryFetch = async (proxyBase) => {
                const xcUrl = `https://xeno-canto.org/api/3/recordings?query=${encodeURIComponent(q)}&key=${apiKey}`;
                const response = await fetch(`${proxyBase}${encodeURIComponent(xcUrl)}`);
                if (!response.ok) throw new Error(`Status ${response.status}`);
                const wrapper = await response.json();
                return typeof wrapper.contents === 'string' ? JSON.parse(wrapper.contents) : wrapper;
            };

            const proxies = ["https://corsproxy.io/?", "https://api.allorigins.win/get?url=", "https://api.codetabs.com/v1/proxy?url="];

            try {
                let lastErr = null;
                for (let attempt = 0; attempt < 2; attempt++) {
                    for (const proxy of proxies) {
                        try {
                            const data = await tryFetch(proxy);
                            if (data.error) {
                                const msg = (typeof data.error === 'object' ? data.error.message : data.message) || data.error;
                                if (data.error === "client_error" || msg.toLowerCase().includes("api key")) throw new Error("Invalid or Missing API Key");
                                throw new Error(msg || "Unknown API Error");
                            }
                            let recordings = data.recordings || [];
                            recordings.forEach(rec => {
                                const sci = `${rec.gen || ''} ${rec.sp || ''}`.trim();
                                if (SCI_TO_FAMILY[sci]) rec.family = SCI_TO_FAMILY[sci];
                            });

                            speciesMetadataCache.set(species, recordings);
                            return recordings;
                        } catch (e) {
                            lastErr = e;
                            if (e.message.includes("API Key")) throw e;
                        }
                    }
                    if (attempt === 0) await new Promise(r => setTimeout(r, 1000));
                }
                throw lastErr || new Error("All proxies failed");
            } catch (e) {
                console.error(`XC Fetch failed for ${species}:`, e);
                return { error: e.message };
            }
        }

        async function fetchBirdImage(sciName) {
            try {
                const query = sciName.replace(' ', '_');
                const url = `https://en.wikipedia.org/w/api.php?action=query&prop=pageimages&format=json&piprop=thumbnail&pithumbsize=600&titles=${query}&redirects=1&origin=*`;
                const res = await fetch(url);
                const data = await res.json();
                const pages = data.query.pages;
                for (let pid in pages) {
                    if (pages[pid].thumbnail) return { url: pages[pid].thumbnail.source, rightsHolder: "Wikipedia Contributors", license: "CC BY-SA" };
                }
            } catch (e) { }
            return null;
        }

        function populateFamilyDropdown() {
            const families = Array.from(new Set(SPECIES_LIST.map(s => s.family).filter(f => !!f)));
            familySelect.innerHTML = '<option value="">Add a Family...</option>';
            families.sort().forEach((family) => {
                const opt = document.createElement('option');
                opt.value = family;
                opt.innerText = family;
                familySelect.appendChild(opt);
            });
        }

        async function getFamilySpecies(family) {
            if (familyToSpeciesList.has(family)) return familyToSpeciesList.get(family);
            const speciesInFamily = SPECIES_LIST.filter(s => s.family === family).map(s => s.en);
            familyToSpeciesList.set(family, speciesInFamily);
            return speciesInFamily;
        }

        const startScreen = document.getElementById('startScreen');
        const sessionScreen = document.getElementById('sessionScreen');
        const cardContainer = document.getElementById('cardContainer');
        const revealBtn = document.getElementById('revealBtn');
        const ratingButtons = document.getElementById('ratingButtons');
        const speciesEl = document.getElementById('speciesName');
        const speciesFamilyEl = document.getElementById('speciesFamily');
        const vocalTypeEl = document.getElementById('vocalType');
        const promptText = document.getElementById('promptText');
        const playBtn = document.getElementById('playButton');
        const pauseBtn = document.getElementById('pauseButton');
        const statsText = document.getElementById('statsText');
        const resetBtn = document.getElementById('resetBtn');
        const viz = document.getElementById('viz');
        const birdAudio = document.getElementById('birdAudio');
        const speciesResults = document.getElementById('speciesResults');
        const locationEl = document.getElementById('locationTag');
        const speciesImageEl = document.getElementById('speciesImage');
        const imageAttributionEl = document.getElementById('imageAttribution');
        const loadingOverlay = document.getElementById('loading');
        const speciesSearch = document.getElementById('speciesSearch');
        const familySelect = document.getElementById('familySelect');
        const selectedFamiliesList = document.getElementById('selectedFamiliesList');
        const selectedSpeciesList = document.getElementById('selectedSpeciesList');

        toggleAdvanced.onclick = () => advancedSettings.classList.toggle('hidden');

        const setupView = document.getElementById('setupView');
        const studyView = document.getElementById('studyView');
        const endSessionBtn = document.getElementById('endSessionBtn');

        let allRegions = []; // Unified list of all regions

        function endSession() {
            if (confirm("End current session and go back to setup?")) {
                isSessionActive = false;
                birdAudio.pause();
                setupView.classList.remove('hidden');
                studyView.classList.add('hidden');
                // Reset study view state if needed, or keep it for next time
            }
        }

        endSessionBtn.onclick = endSession;

        async function createSession() {
            // ... existing calculation logic ...
            // Calculate final list again to be absolutely sure
            let finalSpecies = [];
            let regionalSciNames = regionSpeciesPool;
            let candidates = new Set(selectedSpecies);
            selectedFamilies.forEach(fam => {
                SPECIES_LIST.filter(s => s.family === fam).forEach(s => candidates.add(s.en));
            });

            if (candidates.size > 0) {
                finalSpecies = Array.from(candidates).filter(en => {
                    if (!regionalSciNames) return true;
                    return regionalSciNames.has(EN_TO_SCI[en]);
                });
            } else if (regionalSciNames) {
                finalSpecies = SPECIES_LIST.filter(s => regionalSciNames.has(s.sci)).map(s => s.en);
            }

            if (finalSpecies.length === 0) {
                return alert("No species found for the selected criteria. Check your region/family overlap!");
            }

            // UI Transition
            loadingBanner.classList.remove('hidden');
            createSessionBtn.disabled = true;

            const speciesList = finalSpecies;
            currentPool = [];
            let errorCount = 0;
            let lastError = "";

            const batchSize = 5;
            for (let i = 0; i < speciesList.length; i += batchSize) {
                const batch = speciesList.slice(i, i + batchSize);
                const progress = Math.round((i / speciesList.length) * 100);
                loadingStatus.innerText = `Loading ${i + 1}-${Math.min(i + batchSize, speciesList.length)} of ${speciesList.length} species...`;
                progressBarFill.style.width = `${progress}%`;

                const results = await Promise.allSettled(batch.map(sp => fetchSpeciesData(sp)));
                results.forEach(res => {
                    if (res.status === 'fulfilled' && !res.value.error) currentPool.push(...res.value);
                    else { errorCount++; lastError = res.value?.error || "Fetch failed"; }
                });

                if (i + batchSize < speciesList.length) await new Promise(r => setTimeout(r, 600));
            }

            loadingBanner.classList.add('hidden');
            createSessionBtn.disabled = false;

            if (currentPool.length > 0) {
                // SWITCH VIEWS
                setupView.classList.add('hidden');
                studyView.classList.remove('hidden');

                // Start Session
                isSessionActive = true;
                sessionScreen.classList.remove('hidden-card');
                cardContainer.classList.remove('hidden-card');
                loadNext();
            } else if (errorCount > 0) {
                alert(`Could not load any recordings. Last error: ${lastError}`);
            }
        }

        createSessionBtn.onclick = createSession;

        function renderSelectedFamilies() {
            selectedFamiliesList.innerHTML = '';
            selectedFamilies.forEach(fam => {
                const chip = document.createElement('div');
                chip.className = 'filter-chip active';
                chip.innerText = fam + ' ×';
                chip.onclick = () => { selectedFamilies.delete(fam); renderSelectedFamilies(); };
                selectedFamiliesList.appendChild(chip);
            });
            refreshSpeciesList();
        }

        familySelect.onchange = (e) => {
            if (e.target.value) { selectedFamilies.add(e.target.value); e.target.value = ''; renderSelectedFamilies(); }
        };

        speciesSearch.oninput = (e) => {
            const term = e.target.value.toLowerCase();
            if (term.length < 2) { speciesResults.classList.add('hidden'); return; }
            const matches = SPECIES_LIST.filter(s => s.en.toLowerCase().includes(term) || s.sci.toLowerCase().includes(term)).slice(0, 10);
            speciesResults.innerHTML = '';
            if (matches.length === 0) { speciesResults.classList.add('hidden'); return; }
            matches.forEach(m => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.innerText = m.en;
                item.onclick = () => { selectedSpecies.add(m.en); speciesSearch.value = ''; speciesResults.classList.add('hidden'); renderSelectedSpecies(); };
                speciesResults.appendChild(item);
            });
            speciesResults.classList.remove('hidden');
        };

        function renderSelectedSpecies() {
            selectedSpeciesList.innerHTML = '';
            selectedSpecies.forEach(sp => {
                const chip = document.createElement('div');
                chip.className = 'filter-chip active';
                chip.innerText = sp + ' ×';
                chip.onclick = () => { selectedSpecies.delete(sp); renderSelectedSpecies(); };
                selectedSpeciesList.appendChild(chip);
            });
            refreshSpeciesList();
        }

        resetBtn.onclick = () => { if (confirm("This will clear all your learning progress (mastered birds, etc). Proceed?")) { localStorage.removeItem('mimid_metadata'); location.reload(); } };

        function resetAudioControls() {
            viz.style.display = 'none';
            pauseBtn.style.display = 'none';
            playBtn.style.display = 'flex';
            promptText.innerText = "Playing vocalization...";
        }

        function loadNext() {
            if (currentPool.length === 0) { alert("No recordings available for this criteria!"); location.reload(); return; }

            // Stop previous audio and reset UI immediately
            birdAudio.pause();
            birdAudio.currentTime = 0;
            resetAudioControls();

            // Group recordings by species ID to ensure balanced species selection
            const speciesMap = {};
            currentPool.forEach(rec => {
                const spId = `${rec.gen} ${rec.sp}`; // Use scientific name as unique key
                if (!speciesMap[spId]) speciesMap[spId] = [];
                speciesMap[spId].push(rec);
            });

            const uniqueSpecies = Object.keys(speciesMap);
            if (uniqueSpecies.length === 0) { alert("No species found!"); location.reload(); return; }

            // 1. Pick a random species
            const randomSpecies = uniqueSpecies[Math.floor(Math.random() * uniqueSpecies.length)];
            const speciesRecordings = speciesMap[randomSpecies];

            // 2. Pick a random recording from that species
            currentRecord = speciesRecordings[Math.floor(Math.random() * speciesRecordings.length)];

            isFlipped = false;

            // UI Reset for new card
            cardContainer.classList.remove('hidden-card'); // Ensure visible
            revealBtn.style.display = 'block'; // Reset answer button
            ratingButtons.classList.add('hidden-card'); // Hide rating buttons
            cardContainer.classList.remove('flipped'); // Ensure front face

            speciesImageEl.src = ""; speciesImageEl.style.display = 'none'; imageAttributionEl.innerText = "";
            const sci = `${currentRecord.gen} ${currentRecord.sp}`.trim();
            fetchBirdImage(sci).then(img => {
                if (img) { speciesImageEl.src = img.url; speciesImageEl.style.display = 'block'; imageAttributionEl.innerText = `© ${img.rightsHolder} (${img.license})`; }
            });
            speciesEl.innerText = currentRecord.en;
            speciesFamilyEl.innerText = currentRecord.family || "";
            vocalTypeEl.innerText = currentRecord.type;
            locationEl.innerText = currentRecord.cnt;
            birdAudio.src = currentRecord.file.startsWith('//') ? 'https:' + currentRecord.file : currentRecord.file;

            // Attempt autoplay
            birdAudio.play()
                .then(() => {
                    viz.style.display = 'flex';
                    playBtn.style.display = 'none';
                    pauseBtn.style.display = 'flex';
                })
                .catch((e) => {
                    console.log("Autoplay prevented:", e.message);
                });
        }

        function playAudio() { birdAudio.play(); viz.style.display = 'flex'; playBtn.style.display = 'none'; pauseBtn.style.display = 'flex'; }
        function pauseAudio() { birdAudio.pause(); viz.style.display = 'none'; pauseBtn.style.display = 'none'; playBtn.style.display = 'flex'; }

        revealBtn.onclick = () => { isFlipped = true; cardContainer.classList.add('flipped'); revealBtn.style.display = 'none'; ratingButtons.classList.remove('hidden-card'); };
        playBtn.onclick = (e) => { e.stopPropagation(); playAudio(); };
        pauseBtn.onclick = (e) => { e.stopPropagation(); pauseAudio(); };
        cardContainer.onclick = () => { if (birdAudio.paused) playAudio(); else pauseAudio(); };

        document.querySelectorAll('.rating-btn').forEach(btn => {
            btn.onclick = (e) => {
                e.stopPropagation();
                console.log("Rating button clicked:", btn.dataset.grade);
                try {
                    if (!currentRecord) { console.error("No current record!"); return; }

                    const grade = parseInt(btn.dataset.grade);
                    const id = String(currentRecord.id);
                    const meta = getMetadata();
                    let card = meta[id] || { easyStreak: 0 };

                    if (grade === 1 || grade === 2) card.easyStreak = 0;
                    else {
                        card.easyStreak++;
                        if (card.easyStreak >= 3) {
                            card.mastered = true;
                            currentPool = currentPool.filter(r => String(r.id) !== id);
                        }
                    }

                    localStorage.setItem('mimid_metadata', JSON.stringify({ ...meta, [id]: card }));

                    // Flip back immediately
                    console.log("Flipping back...");
                    isFlipped = false;
                    cardContainer.classList.remove('flipped');
                    ratingButtons.classList.add('hidden-card');

                    // Wait for flip animation (600ms) to finish before loading next card content
                    setTimeout(() => {
                        console.log("Loading next card...");
                        revealBtn.style.display = 'block';
                        loadNext();
                    }, 600);
                } catch (err) {
                    console.error("Error in rating handler:", err);
                    alert("Error: " + err.message);
                }
            };
        });

        // ... existing render functions ...

        // ... init function ...
        async function init() {
            // ... existing key loading ...
            const keyStatus = document.getElementById('keyStatus');
            const storedXCKey = localStorage.getItem('mimid_xc_key');
            const storedEBirdKey = localStorage.getItem('mimid_ebird_key');
            // ... (keep key loading logic) ...
            if (storedXCKey && storedXCKey !== "demo") { xcApiKeyInput.value = storedXCKey; }
            if (storedEBirdKey) { eBirdApiKeyInput.value = storedEBirdKey; eBirdKey = storedEBirdKey; }
            if (storedXCKey || storedEBirdKey) { keyStatus.innerText = "Status: Loaded from Browser Storage"; keyStatus.style.color = "#4ade80"; }

            eBirdApiKeyInput.oninput = () => { eBirdKey = eBirdApiKeyInput.value.trim(); localStorage.setItem('mimid_ebird_key', eBirdKey); };
            xcApiKeyInput.oninput = () => { localStorage.setItem('mimid_xc_key', xcApiKeyInput.value.trim()); };

            try {
                const configRes = await fetch('config.json');
                if (configRes.ok) {
                    const configData = await configRes.json();
                    const xcKey = configData['xc-key'] || configData.key;
                    if (xcKey && xcKey !== "PASTE_YOUR_KEY_HERE") {
                        xcApiKeyInput.value = xcKey; xcApiKeyInput.disabled = true; xcApiKeyInput.style.opacity = "0.7"; localStorage.setItem('mimid_xc_key', xcKey);
                    }
                    const ebKey = configData['eBird-key'];
                    if (ebKey && ebKey !== "PASTE_YOUR_KEY_HERE") {
                        eBirdKey = ebKey; eBirdApiKeyInput.value = ebKey; eBirdApiKeyInput.disabled = true; eBirdApiKeyInput.style.opacity = "0.7"; localStorage.setItem('mimid_ebird_key', ebKey);
                    }
                    keyStatus.innerText = "Status: Active (System Secret)"; keyStatus.style.color = "#4ade80";
                }
            } catch (e) { console.log("No config.json found."); }


            // Load eBird Taxonomy mapping
            try {
                const mappingRes = await fetch('ebird_to_sci.json');
                if (mappingRes.ok) { ebirdToSci = await mappingRes.json(); }
            } catch (e) { console.error("Failed to load eBird taxonomy mapping", e); }

            // Load and Unify Region CSVs
            const regionFiles = [
                { file: 'us-states', type: 'US State' },
                { file: 'ca-provinces', type: 'CA Province' },
                { file: 'countries', type: 'Country' }
            ];

            for (const item of regionFiles) {
                try {
                    const res = await fetch(`regions/${item.file}.csv`);
                    if (res.ok) {
                        const csvText = await res.text();
                        const lines = csvText.split('\n').slice(1);
                        lines.forEach(line => {
                            if (!line.trim()) return;
                            const [code, name] = line.split(',');
                            allRegions.push({
                                code: code.trim().replace(/"/g, ''),
                                name: name.trim().replace(/"/g, ''),
                                type: item.type
                            });
                        });
                    }
                } catch (e) { console.error(`Failed to load region file ${item.file}`, e); }
            }

            // Unified Region Search
            const regionSearchContainer = document.getElementById('regionSearchContainer'); // Wrapper (removed in HTML, need to check if wrapper exists or if used directly)
            // Actually in new HTML, wrapper is div with class relative.
            const regionSearchInput = document.getElementById('regionSearch');
            const regionResults = document.getElementById('regionResults');

            regionSearchInput.oninput = (e) => {
                const term = e.target.value.toLowerCase();
                if (term.length < 2) { regionResults.classList.add('hidden'); return; }

                const matches = allRegions.filter(r => r.name.toLowerCase().includes(term) || r.code.toLowerCase().includes(term));
                regionResults.innerHTML = '';

                if (matches.length === 0) { regionResults.classList.add('hidden'); return; }

                matches.slice(0, 50).forEach(m => { // Limit results for performance
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    item.innerHTML = `<span style="font-weight:600;">${m.name}</span> <span style="font-size:0.8em; color:var(--text-muted);">(${m.type})</span>`;
                    item.onclick = async () => {
                        regionSearchInput.value = m.name;
                        selectedRegionCode = m.code;
                        regionResults.classList.add('hidden');

                        // Immediate Fetch
                        regionSpeciesPool = null;
                        refreshSpeciesList();

                        const ebirdUrl = `https://api.ebird.org/v2/product/spplist/${selectedRegionCode}?key=${eBirdKey}`;
                        const proxies = ["https://corsproxy.io/?", "https://api.allorigins.win/get?url=", "https://api.codetabs.com/v1/proxy?url="];

                        for (const proxy of proxies) {
                            try {
                                const res = await fetch(`${proxy}${encodeURIComponent(ebirdUrl)}`);
                                if (res.ok) {
                                    const data = await res.json();
                                    let rawData = (data && data.contents) ? (typeof data.contents === 'string' ? JSON.parse(data.contents) : data.contents) : data;
                                    if (Array.isArray(rawData)) {
                                        regionSpeciesPool = new Set(rawData.map(code => ebirdToSci[code]).filter(n => !!n));
                                        console.log(`Loaded ${regionSpeciesPool.size} species for ${selectedRegionCode}`);
                                        refreshSpeciesList();
                                        break;
                                    }
                                }
                            } catch (e) { console.error("eBird fetch failed", e); }
                        }

                        // If we finished the loop and still no data
                        if (!regionSpeciesPool) {
                            console.error("Failed to load eBird data from all proxies");
                            // Set to empty set so UI stops spinning and shows 0 matches
                            regionSpeciesPool = new Set();
                            refreshSpeciesList();
                            alert("Failed to load regional data. Please check your internet connection or try another region.");
                        }
                    };
                    regionResults.appendChild(item);
                });
                regionResults.classList.remove('hidden');
            };

            // Load Species DB
            try {
                const res = await fetch('all_species.json');
                if (!res.ok) throw new Error("Could not load species database");
                SPECIES_LIST = await res.json();
                SPECIES_LIST.forEach(s => { if (s.sci) SCI_TO_FAMILY[s.sci] = s.family; if (s.en) EN_TO_SCI[s.en] = s.sci; });
                loadingOverlay.classList.add('hidden');
                populateFamilyDropdown();
            } catch (e) {
                loadingOverlay.innerHTML = `<p style="color:red;">Error: ${e.message}</p>`;
            }
        }

        init();
    </script>
</body>

</html>