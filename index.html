<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mimid</title>
    <meta name="description"
        content="Master bird sounds with dynamic flashcards powered by the Cornell Guide to Bird Sounds.">
    <link rel="stylesheet" href="index.css">
</head>

<body>
    <div id="loading" class="loading-overlay">
        <div class="audio-controls">
            <div class="visualizer">
                <div class="bar" style="animation-delay: 0.0s"></div>
                <div class="bar" style="animation-delay: 0.1s"></div>
                <div class="bar" style="animation-delay: 0.2s"></div>
                <div class="bar" style="animation-delay: 0.3s"></div>
                <div class="bar" style="animation-delay: 0.4s"></div>
                <div class="bar" style="animation-delay: 0.5s"></div>
            </div>
            <p>Loading...</p>
        </div>
    </div>

    <div id="app">
        <header>
            <h1>mimid</h1>
        </header>

        <aside class="settings-panel">
            <div class="settings-section">
                <h3>Families</h3>
                <div style="position: relative; margin-bottom: 0.5rem;">
                    <select id="familySelect" class="search-input" style="cursor: pointer;">
                        <option value="">Select a Family...</option>
                    </select>
                </div>
                <div class="filter-list" id="selectedFamiliesList">
                    <!-- Selected family chips will appear here -->
                </div>
            </div>

            <div class="settings-section">
                <h3>Custom Group</h3>
                <div class="filter-list" id="selectedSpeciesList">
                    <!-- Selected individual species chips -->
                </div>
                <div style="position: relative;">
                    <input type="text" id="speciesSearch" class="search-input" placeholder="Search to add species..."
                        autocomplete="off">
                    <div id="speciesResults" class="dropdown-results hidden"></div>
                </div>
            </div>

            <div class="settings-section">
                <h3>Vocalizations</h3>
                <div class="filter-list" id="typeFilters">
                    <!-- Dynamic chips -->
                </div>
            </div>

            <div class="settings-section">
                <h3>Region</h3>
                <div class="filter-list" id="regionFilters">
                    <!-- Dynamic region chips -->
                </div>
            </div>
        </aside>

        <main class="main-content">
            <div id="startScreen" style="text-align: center;">
                <p style="margin-bottom: 2rem; font-size: 1.2rem; max-width: 500px; line-height: 1.6;">
                    Select your <strong>study species</strong> and <strong>vocalization types</strong> from the sidebar,
                    then click Start to begin.
                </p>
                <button class="primary" id="startBtn" style="font-size: 1.2rem; padding: 1rem 3rem;">Start
                    Session</button>
            </div>

            <div class="card-container hidden-card" id="cardContainer">
                <div class="flashcard">
                    <div class="card-face front">
                        <div class="audio-controls">
                            <button class="play-button" id="playButton">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="white">
                                    <path d="M8 5v14l11-7z" />
                                </svg>
                            </button>
                            <button class="play-button" id="pauseButton" style="display: none;">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="white">
                                    <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
                                </svg>
                            </button>
                            <p id="promptText">Playing vocalization...</p>
                            <div class="visualizer" id="viz" style="display: none;">
                                <div class="bar" style="animation-delay: 0.0s"></div>
                                <div class="bar" style="animation-delay: 0.2s"></div>
                                <div class="bar" style="animation-delay: 0.4s"></div>
                                <div class="bar" style="animation-delay: 0.1s"></div>
                                <div class="bar" style="animation-delay: 0.3s"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card-face back">
                        <div class="species-image-container">
                            <img id="speciesImage" src="" alt="">
                            <p id="imageAttribution" class="attribution"></p>
                        </div>
                        <h2 class="species-name" id="speciesName">Unknown</h2>
                        <p class="species-family" id="speciesFamily"
                            style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;"></p>
                        <p class="vocalization-type" id="vocalType">Song</p>
                        <span class="location-tag" id="locationTag">Unknown</span>
                    </div>
                </div>
            </div>

            <div class="controls hidden-card" id="sessionScreen"
                style="display: none; flex-direction: column; align-items: center;">
                <button class="secondary" id="revealBtn">Reveal Answer</button>
                <div id="ratingButtons" class="rating-group hidden-card">
                    <button class="rating-btn again" data-grade="1">Incorrect</button>
                    <button class="rating-btn hard" data-grade="2">Correct (Hard)</button>
                    <button class="rating-btn easy" data-grade="4">Correct (Easy)</button>
                </div>
                <button class="secondary" id="resetBtn"
                    style="margin-top: 1rem; background: var(--danger); opacity: 0.8;">Reset Session</button>
            </div>
            <p id="statsText" style="margin-top: 1rem; color: var(--text-muted); font-size: 0.9rem;"></p>
        </main>

        <audio id="birdAudio" style="display:none;"></audio>
    </div>

    <script>
        let currentPool = [];
        let currentRecord = null;
        let isFlipped = false;
        let isSessionActive = false;
        let selectedSpecies = new Set();
        let selectedFamilies = new Set();
        let selectedTypes = new Set();
        let selectedRegions = new Set();
        let debounceTimer;

        let SPECIES_LIST = [];
        let familyToSpeciesList = new Map();
        let familySpeciesCounts = new Map();
        let SCI_TO_FAMILY = {};

        const speciesMetadataCache = new Map();

        function getMetadata() {
            return JSON.parse(localStorage.getItem('mimid_metadata') || '{}');
        }

        function saveMetadata(id, data) {
            const meta = getMetadata();
            meta[id] = data;
            localStorage.setItem('mimid_metadata', JSON.stringify(meta));
        }

        async function fetchSpeciesData(species) {
            if (speciesMetadataCache.has(species)) return speciesMetadataCache.get(species);
            let q = `en:"${species}" q:A len:10-60`;
            try {
                // Use a CORS proxy for static hosting (XC does not support CORS)
                const xcUrl = `https://xeno-canto.org/api/2/recordings?query=${encodeURIComponent(q)}`;
                const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(xcUrl)}`;

                const response = await fetch(proxyUrl);
                const data = await response.json();
                const recordings = data.recordings || [];
                recordings.forEach(rec => {
                    const sci = `${rec.gen || ''} ${rec.sp || ''}`.trim();
                    if (SCI_TO_FAMILY[sci]) rec.family = SCI_TO_FAMILY[sci];
                });
                speciesMetadataCache.set(species, recordings);
                return recordings;
            } catch (e) {
                console.error("XC Fetch Error", species, e);
                return [];
            }
        }

        async function fetchBirdImage(sciName) {
            try {
                const query = sciName.replace(' ', '_');
                const url = `https://en.wikipedia.org/w/api.php?action=query&prop=pageimages&format=json&piprop=thumbnail&pithumbsize=600&titles=${query}&redirects=1&origin=*`;
                const res = await fetch(url);
                const data = await res.json();
                const pages = data.query.pages;
                for (let pid in pages) {
                    if (pages[pid].thumbnail) {
                        return {
                            url: pages[pid].thumbnail.source,
                            rightsHolder: "Wikipedia Contributors",
                            license: "CC BY-SA"
                        };
                    }
                }
            } catch (e) { console.warn("Wiki image failed", e); }
            return null;
        }

        function populateFamilyDropdown() {
            const families = Array.from(new Set(SPECIES_LIST.map(s => s.family).filter(f => !!f)));
            familySelect.innerHTML = '<option value="">Select a Family...</option>';
            families.sort().forEach((family) => {
                const opt = document.createElement('option');
                opt.value = family;
                opt.innerText = family;
                familySelect.appendChild(opt);
            });
        }

        async function getFamilySpecies(family) {
            if (familyToSpeciesList.has(family)) return familyToSpeciesList.get(family);
            const speciesInFamily = SPECIES_LIST
                .filter(s => s.family === family)
                .map(s => s.en);
            familyToSpeciesList.set(family, speciesInFamily);
            familySpeciesCounts.set(family, speciesInFamily.length);
            return speciesInFamily;
        }

        const startScreen = document.getElementById('startScreen');
        const sessionScreen = document.getElementById('sessionScreen');
        const cardContainer = document.getElementById('cardContainer');
        const revealBtn = document.getElementById('revealBtn');
        const ratingButtons = document.getElementById('ratingButtons');
        const speciesEl = document.getElementById('speciesName');
        const speciesFamilyEl = document.getElementById('speciesFamily');
        const vocalTypeEl = document.getElementById('vocalType');
        const promptText = document.getElementById('promptText');
        const playBtn = document.getElementById('playButton');
        const pauseBtn = document.getElementById('pauseButton');
        const statsText = document.getElementById('statsText');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const viz = document.getElementById('viz');
        const birdAudio = document.getElementById('birdAudio');
        const speciesResults = document.getElementById('speciesResults');
        const typeFilters = document.getElementById('typeFilters');
        const regionFilters = document.getElementById('regionFilters');
        const locationEl = document.getElementById('locationTag');
        const speciesImageEl = document.getElementById('speciesImage');
        const imageAttributionEl = document.getElementById('imageAttribution');
        const loadingOverlay = document.getElementById('loading');
        const speciesSearch = document.getElementById('speciesSearch');
        const familySelect = document.getElementById('familySelect');
        const selectedFamiliesList = document.getElementById('selectedFamiliesList');
        const selectedSpeciesList = document.getElementById('selectedSpeciesList');

        async function updateAvailableTypes() {
            const allSpeciesToFetch = new Set(selectedSpecies);
            selectedFamilies.forEach(family => {
                const speciesInFamily = familyToSpeciesList.get(family) || [];
                speciesInFamily.forEach(sp => allSpeciesToFetch.add(sp));
            });

            const speciesList = Array.from(allSpeciesToFetch);
            if (speciesList.length === 0) {
                typeFilters.innerHTML = '<div class="filter-chip" style="cursor:default; background:transparent;">Select families or species first</div>';
                regionFilters.innerHTML = '<div class="filter-chip" style="cursor:default; background:transparent;">Select families or species first</div>';
                return;
            }

            typeFilters.innerHTML = 'Loading types...';
            regionFilters.innerHTML = 'Loading regions...';

            const allRecordings = [];
            const fetchList = speciesList.filter(sp => !speciesMetadataCache.has(sp));
            speciesList.forEach(sp => { if (speciesMetadataCache.has(sp)) allRecordings.push(...speciesMetadataCache.get(sp)); });

            if (fetchList.length > 0) {
                const results = await Promise.all(fetchList.map(sp => fetchSpeciesData(sp)));
                results.forEach(recs => allRecordings.push(...recs));
            }

            typeFilters.innerHTML = '';
            regionFilters.innerHTML = '';

            if (allRecordings.length === 0) {
                typeFilters.innerHTML = 'No recordings found';
                return;
            }

            const activeRecordings = selectedRegions.size > 0
                ? allRecordings.filter(r => selectedRegions.has(r.cnt))
                : allRecordings;

            const typeCounts = new Map();
            activeRecordings.forEach(rec => {
                (rec.type || "unknown").toLowerCase().split(',').map(t => t.trim()).forEach(t => {
                    if (!t) return;
                    const norm = t.charAt(0).toUpperCase() + t.slice(1);
                    typeCounts.set(norm, (typeCounts.get(norm) || 0) + 1);
                });
            });

            Array.from(typeCounts.entries()).sort((a, b) => b[1] - a[1]).slice(0, 10).forEach(([type, count]) => {
                const chip = document.createElement('div');
                chip.className = 'filter-chip';
                if (selectedTypes.has(type)) chip.classList.add('active');
                chip.innerText = `${type} (${count})`;
                chip.onclick = () => { toggleFilter(selectedTypes, type, chip); updateAvailableTypes(); renderSelectedFamilies(); };
                typeFilters.appendChild(chip);
            });

            const activeForRegion = selectedTypes.size > 0
                ? allRecordings.filter(rec => Array.from(selectedTypes).some(t => (rec.type || "").toLowerCase().includes(t.toLowerCase())))
                : allRecordings;

            const regionCounts = new Map();
            activeForRegion.forEach(rec => {
                const reg = rec.cnt || "Unknown";
                regionCounts.set(reg, (regionCounts.get(reg) || 0) + 1);
            });

            Array.from(regionCounts.entries()).sort((a, b) => b[1] - a[1]).slice(0, 10).forEach(([reg, count]) => {
                const chip = document.createElement('div');
                chip.className = 'filter-chip';
                if (selectedRegions.has(reg)) chip.classList.add('active');
                chip.innerText = `${reg} (${count})`;
                chip.onclick = () => { toggleFilter(selectedRegions, reg, chip); updateAvailableTypes(); renderSelectedFamilies(); };
                regionFilters.appendChild(chip);
            });
        }

        function toggleFilter(set, val, el) {
            if (set.has(val)) set.delete(val); else set.add(val);
            el.classList.toggle('active');
        }

        async function renderSelectedFamilies() {
            selectedFamiliesList.innerHTML = '';
            for (const fam of selectedFamilies) {
                const chip = document.createElement('div');
                chip.className = 'filter-chip active';
                const sps = await getFamilySpecies(fam);
                let count = sps.length;
                if (selectedTypes.size > 0 || selectedRegions.size > 0) {
                    count = sps.filter(s => {
                        if (!speciesMetadataCache.has(s)) return false;
                        return speciesMetadataCache.get(s).some(r => {
                            let mt = selectedTypes.size === 0 || Array.from(selectedTypes).some(t => (r.type || "").toLowerCase().includes(t.toLowerCase()));
                            let mr = selectedRegions.size === 0 || selectedRegions.has(r.cnt);
                            return mt && mr;
                        });
                    }).length;
                }
                chip.innerText = `${fam} (${count}) ×`;
                chip.onclick = () => { selectedFamilies.delete(fam); renderSelectedFamilies(); updateAvailableTypes(); };
                selectedFamiliesList.appendChild(chip);
            }
        }

        familySelect.addEventListener('change', async (e) => {
            if (e.target.value) {
                selectedFamilies.add(e.target.value);
                e.target.value = '';
                await renderSelectedFamilies();
                updateAvailableTypes();
            }
        });

        speciesSearch.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            clearTimeout(debounceTimer);
            if (term.length < 2) { speciesResults.classList.add('hidden'); return; }
            debounceTimer = setTimeout(() => {
                const matches = SPECIES_LIST.filter(s => s.en.toLowerCase().includes(term) || s.sci.toLowerCase().includes(term)).slice(0, 10);
                speciesResults.innerHTML = '';
                if (matches.length === 0) { speciesResults.classList.add('hidden'); return; }
                matches.forEach(m => {
                    const item = document.createElement('div');
                    item.className = 'dropdown-item';
                    item.innerText = m.en;
                    item.onclick = () => {
                        selectedSpecies.add(m.en);
                        speciesSearch.value = '';
                        speciesResults.classList.add('hidden');
                        renderSelectedSpecies();
                        updateAvailableTypes();
                    };
                    speciesResults.appendChild(item);
                });
                speciesResults.classList.remove('hidden');
            }, 100);
        });

        function renderSelectedSpecies() {
            selectedSpeciesList.innerHTML = '';
            selectedSpecies.forEach(sp => {
                const chip = document.createElement('div');
                chip.className = 'filter-chip active';
                chip.innerText = sp + ' ×';
                chip.onclick = () => { selectedSpecies.delete(sp); renderSelectedSpecies(); updateAvailableTypes(); };
                selectedSpeciesList.appendChild(chip);
            });
        }

        startBtn.addEventListener('click', async () => {
            if (selectedFamilies.size === 0 && selectedSpecies.size === 0) return alert("Select birds first!");
            loadingOverlay.classList.remove('hidden');
            const toFetch = new Set(selectedSpecies);
            for (const f of selectedFamilies) (await getFamilySpecies(f)).forEach(s => toFetch.add(s));

            let combined = [];
            for (const s of Array.from(toFetch)) {
                const recs = await fetchSpeciesData(s);
                combined.push(...recs);
            }

            if (selectedTypes.size > 0) combined = combined.filter(r => Array.from(selectedTypes).some(t => (r.type || "").toLowerCase().includes(t.toLowerCase())));
            if (selectedRegions.size > 0) combined = combined.filter(r => selectedRegions.has(r.cnt));

            if (combined.length === 0) { loadingOverlay.classList.add('hidden'); return alert("No recordings found!"); }

            currentPool = combined;
            isSessionActive = true;
            loadingOverlay.classList.add('hidden');
            startScreen.style.display = 'none';
            sessionScreen.style.display = 'flex';
            cardContainer.classList.remove('hidden-card');
            loadNext();
        });

        resetBtn.addEventListener('click', () => { if (confirm("Reset?")) { localStorage.removeItem('mimid_metadata'); location.reload(); } });

        function loadNext() {
            if (currentPool.length === 0) { alert("Done!"); location.reload(); return; }
            currentRecord = currentPool[Math.floor(Math.random() * currentPool.length)];
            isFlipped = false;
            cardContainer.classList.remove('flipped');
            revealBtn.style.display = 'block';
            ratingButtons.classList.add('hidden-card');
            speciesImageEl.src = ""; speciesImageEl.style.display = 'none'; imageAttributionEl.innerText = "";
            const sci = `${currentRecord.gen} ${currentRecord.sp}`.trim();
            fetchBirdImage(sci).then(img => {
                if (img) {
                    speciesImageEl.src = img.url;
                    speciesImageEl.style.display = 'block';
                    imageAttributionEl.innerText = `© ${img.rightsHolder} (${img.license})`;
                }
            });
            speciesEl.innerText = currentRecord.en;
            speciesFamilyEl.innerText = currentRecord.family || "";
            vocalTypeEl.innerText = currentRecord.type;
            locationEl.innerText = currentRecord.cnt;
            birdAudio.src = currentRecord.file.startsWith('//') ? 'https:' + currentRecord.file : currentRecord.file;
            birdAudio.play().then(() => { viz.style.display = 'flex'; playBtn.style.display = 'none'; pauseBtn.style.display = 'flex'; }).catch(() => { });
        }

        function playAudio() { birdAudio.play(); viz.style.display = 'flex'; playBtn.style.display = 'none'; pauseBtn.style.display = 'flex'; }
        function pauseAudio() { birdAudio.pause(); viz.style.display = 'none'; pauseBtn.style.display = 'none'; playBtn.style.display = 'flex'; }

        revealBtn.addEventListener('click', () => { isFlipped = true; cardContainer.classList.add('flipped'); revealBtn.style.display = 'none'; ratingButtons.classList.remove('hidden-card'); });
        playBtn.addEventListener('click', (e) => { e.stopPropagation(); playAudio(); });
        pauseBtn.addEventListener('click', (e) => { e.stopPropagation(); pauseAudio(); });
        cardContainer.addEventListener('click', () => { if (birdAudio.paused) playAudio(); else pauseAudio(); });

        document.querySelectorAll('.rating-btn').forEach(btn => btn.addEventListener('click', () => {
            const grade = parseInt(btn.dataset.grade);
            const id = String(currentRecord.id);
            const meta = getMetadata();
            let card = meta[id] || { easyStreak: 0 };
            if (grade === 1) card.easyStreak = 0;
            else if (grade === 2) card.easyStreak = 0;
            else { card.easyStreak++; if (card.easyStreak >= 3) { card.mastered = true; currentPool = currentPool.filter(r => String(r.id) !== id); } }
            meta[id] = card;
            localStorage.setItem('mimid_metadata', JSON.stringify(meta));
            loadNext();
        }));

        async function init() {
            try {
                const res = await fetch('all_species.json');
                SPECIES_LIST = await res.json();
                SPECIES_LIST.forEach(s => { if (s.sci) SCI_TO_FAMILY[s.sci] = s.family; });
                loadingOverlay.classList.add('hidden');
                populateFamilyDropdown();
            } catch (e) { console.error(e); }
        }

        init();
    </script>
</body>

</html>